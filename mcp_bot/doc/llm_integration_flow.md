# Інтеграція зовнішньої LLM у GZDoom: флоу, діаграми, точки збору інформації

## 1. Загальний флоу запуску гри

1. **Запуск**:  
   - Вхідна точка — функція `D_DoomMain_Internal` (../../src/d_main.cpp:3582, виклик ../../src/d_main.cpp:3770).
   - Ініціалізація ресурсів, налаштувань, завантаження WAD-файлів, парсинг параметрів командного рядка.

2. **Ініціалізація гри**:  
   - Основна функція ініціалізації — `D_InitGame` (../../src/d_main.cpp:3066).
   - Викликає налаштування рівня, гравців, класів, ресурсів, конфігурацій, ігрового стану.

3. **Головний цикл**:  
   - Обробка подій, апдейт ігрового світу, рендеринг кадру.
   - Основні функції:  
     - `G_Ticker()` (../../src/g_game.cpp:1111) — оновлення стану світу (логіка, фізика, AI).
     - `G_Responder()` (../../src/g_game.cpp) — обробка подій (input).
     - `D_Display()` (../../src/d_main.cpp:899) — рендеринг кадру.

---

## 2. Діаграма флоу (спрощено)

```mermaid
flowchart TD
    A[Старт програми] --> B[D_InitGame]
    B --> C[G_InitNew / G_DoLoadLevel]
    C --> D[Головний цикл]
    D --> E[G_Ticker (логіка)]
    D --> F[G_Responder (input)]
    D --> G[D_Display (рендер)]
    E --> D
    F --> D
    G --> D
```

---

## 3. Де знаходиться інформація про гравця та його оточення

### Основні структури:

- ../../src/playsim/d_player.h:306 — player_t: структура гравця (позиція, стан, камера, інвентар, тощо).
- ../../src/playsim/actor.h:810 — AActor: об'єкт-актор (гравець, монстр, предмет, тощо).
- ../../src/g_levellocals.h — FLevelLocals: структура рівня (мапа, об'єкти, гравці).

### Де отримати інформацію про гравця:

- **player_t**:
  - `mo` — вказівник на `AActor`, що представляє гравця у світі.
  - `camera` — камера, через яку гравець бачить світ.
  - `viewz`, `Vel`, `Angles`, `health`, `inventory` — координати, швидкість, кут огляду, здоров'я, інвентар.

- **AActor**:
  - `Pos()` — позиція у світі.
  - `Angles` — напрямок погляду.
  - `Sector` — сектор мапи, де знаходиться актор.

- **FLevelLocals**:
  - `Players[]` — масив гравців на рівні.
  - `GetThinkerIterator<AActor>()` — ітератор по всіх акторах.

---

## 4. Де і коли формується інформація для рендеру

- **Рендеринг** відбувається у функції `D_Display()` (../../src/d_main.cpp:899), яка використовує поточний стан світу.
- Перед рендером, у `G_Ticker()` (../../src/g_game.cpp:1111) оновлюється стан світу, позиції, кути, видимість, тощо.
- Для побудови кадру рендер бере:
  - Позицію гравця: `players[consoleplayer].camera->Pos()`
  - Кут огляду: `players[consoleplayer].camera->Angles`
  - Список видимих об'єктів: будується на основі BSP-дерева та позиції гравця.

---

## 5. Де можна "перехопити" інформацію для LLM

### Найзручніше місце — після оновлення стану світу (`G_Ticker`), але до рендеру (`D_Display`):

- **Варіанти:**
  1. **G_Ticker()** — тут вже оновлені всі позиції, кути, стани.
  2. **Перед D_Display()** — тут можна зібрати всю потрібну інформацію про гравця та оточення.
  3. **player_t / AActor** — напряму брати поля для формування JSON/структури для LLM.

### Що можна зібрати:
- Позиція гравця:  
  `players[consoleplayer].camera->Pos()`
- Куди дивиться:  
  `players[consoleplayer].camera->Angles`
- Що бачить (видимі актори):  
  - Можна використати BSP-видимість, або просто зібрати всіх акторів у певному радіусі/секторі.
- Стан гравця:  
  `health`, `inventory`, `weapon`, тощо.

---

## 6. Діаграма інтеграції з LLM

```mermaid
flowchart TD
    subgraph GZDoom
        A1[G_Ticker (оновлення світу)]
        A2[Збір інформації для LLM]
        A3[D_Display (рендер)]
    end
    subgraph LLM
        B1[Отримання JSON/структури]
        B2[Генерація команд]
        B3[Відправка команд у гру]
    end
    A1 --> A2
    A2 --JSON/структура--> B1
    B2 --команда--> GZDoom
    B1 --> B2
    A2 --> A3
```

---

## 7. Висновок: де і як отримувати інформацію

- **Де:**  
  Додати функцію після `G_Ticker()` (або в кінці `G_Ticker`), яка формує структуру (наприклад, JSON) з інформацією про гравця, його позицію, куди дивиться, та видимі об'єкти.
- **Як:**  
  - Зібрати дані з `players[consoleplayer].camera` (`Pos()`, `Angles`, `Sector`, тощо).
  - Зібрати дані про найближчі/видимі актори (через ітератор по акторам, фільтрувати по відстані/видимості).
  - Сформувати структуру і передати її у зовнішню LLM (через IPC, сокет, файл, тощо).

---

### Посилання на ключові місця в коді:
- player_t: ../../src/playsim/d_player.h:306
- AActor: ../../src/playsim/actor.h:810
- FLevelLocals: ../../src/g_levellocals.h
- G_Ticker(): ../../src/g_game.cpp:1111
- D_Display(): ../../src/d_main.cpp:899

---

**Рекомендація:**  
Додавайте точку збору інформації для LLM після оновлення світу, але до рендеру, використовуючи поля `player_t` та `AActor` для формування потрібної структури.
